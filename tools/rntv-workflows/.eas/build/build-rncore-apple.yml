build:
  name: Build RNCore framework for Apple platforms
  steps:
    - eas/checkout
    - eas/install_node_modules
    - run:
        name: Install Ruby
        command: |
          . ./install-ruby.sh
    - run:
        name: Set up build-specific environment
        working_directory: ../..
        command: |
          export ROOT_DIR=$PWD
          set-env ROOT_DIR $ROOT_DIR
    - run:
        name: Build RNTester for tvOS
        working_directory: ../../packages/rn-tester
        command: |
          . ../../tools/rntv-workflows/ruby-env.sh
          mkdir $ROOT_DIR/RNTester-tvOS
          echo "Building RNTester..."
          echo "Cleaning build directories..."
          yarn clean-ios
          echo "Setting up RNTester..."
          yarn setup-ios-hermes
          echo "Building RNTester..."
          yarn build-ios-hermes
          echo "Build completed."
          cp -r $ROOT_DIR/packages/rn-tester/build/Build/Products/Debug-appletvsimulator/RNTester.app $ROOT_DIR/RNTester-tvOS
          cp -r $ROOT_DIR/packages/rn-tester/build/Build/Products/Debug-appletvsimulator/RNTester.app.dSYM $ROOT_DIR/RNTester-tvOS
    - run:
        name: Package Apple artifacts
        working_directory: ../..
        command: |
          export REACT_NATIVE_VERSION=`npx tsx tools/rntv-workflows/src/get-react-native-version.ts`
          echo "REACT_NATIVE_VERSION: $REACT_NATIVE_VERSION"
          (cd RNTester-tvOS; tar zcf $ROOT_DIR/rntester-$REACT_NATIVE_VERSION-appletv-debug.tgz *)
    - eas/upload_artifact:
        name: Upload RNCore Maven artifacts and RNTester apps
        inputs:
          type: build-artifact
          path: |
            rntester-*.tgz

